{"version":3,"sources":["../src/update-issue.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAAA;;;;AACA;;;;;;AAEA,SAAS,SAAT,CAAmB,EAAnB,EAAuB;AACrB,SAAO,sBAAY,UAAC,OAAD,EAAU,MAAV,EAAqB;AACtC,OAAG,UAAC,GAAD,EAAM,MAAN;AAAA,aAAiB,MAAM,OAAO,GAAP,CAAN,GAAoB,QAAQ,MAAR,CAArC;AAAA,KAAH;AACD,GAFM,CAAP;AAGD;;IAEoB,W;AACnB,6BAA4E;AAAA,QAA9D,UAA8D,QAA9D,UAA8D;AAAA,QAAlD,WAAkD,QAAlD,WAAkD;AAAA,QAArC,UAAqC,QAArC,UAAqC;AAAA,QAAzB,UAAyB,QAAzB,UAAyB;AAAA,QAAb,SAAa,QAAb,SAAa;AAAA;;AAC1E,SAAK,UAAL,GAAkB,UAAlB;AACA,SAAK,MAAL,GAAc,mBAAS,MAAT,CAAgB,WAAhB,CAAd;AACA,SAAK,IAAL,GAAY,KAAK,MAAL,CAAY,IAAZ,CAAiB,KAAK,UAAtB,CAAZ;AACA,SAAK,UAAL,GAAkB,UAAlB;AACA,SAAK,kBAAL,GAA0B,iBAAE,QAAF,CAAW,UAAX,CAA1B;AACA,SAAK,iBAAL,GAAyB,iBAAE,QAAF,CAAW,SAAX,CAAzB;AACD;;;;mCAEc,M,EAAQ;AAAA;;AACrB,aAAO,KAAK,cAAL,CAAoB,MAApB,EAA4B,IAA5B,CAAiC,iBAAS;AAC/C,YAAI,KAAJ,EAAW;AACT,iBAAO,MAAK,MAAL,CAAY,KAAZ,EAAmB,MAAnB,CAAP;AACD,SAFD,MAEO;AACL,iBAAO,MAAK,MAAL,CAAY,MAAZ,CAAP;AACD;AACF,OANM,CAAP;AAOD;;;2BAEM,M,EAAQ;AAAA;;AACb,aAAO,UAAU,cAAM;AACrB,eAAK,IAAL,CAAU,KAAV,CAAgB;AACd,iBAAO,OAAK,kBAAL,CAAwB,MAAxB,CADO;AAEd,gBAAM,OAAK,iBAAL,CAAuB,MAAvB,CAFQ;AAGd,kBAAQ,CAAC,OAAK,UAAN;AAHM,SAAhB,EAIG,EAJH;AAKD,OANM,CAAP;AAOD;;;2BAEM,K,EAAO,O,EAAQ;AAAA;;AACpB,UAAM,QAAQ,KAAK,kBAAL,CAAwB,OAAxB,CAAd;AACA,UAAM,OAAO,KAAK,iBAAL,CAAuB,OAAvB,CAAb;AACA,UAAI,UAAU,MAAM,KAAhB,IAAyB,SAAS,MAAM,IAA5C,EAAkD;AAChD,eAAO,kBAAQ,OAAR,CAAgB,KAAhB,CAAP;AACD;;AAED,aAAO,UAAU,cAAM;AACrB,eAAK,MAAL,CAAY,KAAZ,CAAkB,OAAK,UAAvB,EAAmC,MAAM,EAAzC,EAA6C,MAA7C,CAAoD,EAAE,YAAF,EAAS,UAAT,EAApD,EAAqE,EAArE;AACD,OAFM,CAAP;AAGD;;;mCAEc,M,EAAQ;AACrB,UAAM,QAAQ,KAAK,kBAAL,CAAwB,MAAxB,CAAd;AACA,aAAO,KAAK,SAAL,GAAiB,IAAjB,CAAsB;AAAA,eAAU,iBAAE,IAAF,CAAO,MAAP,EAAe,CAAC,OAAD,EAAU,KAAV,CAAf,CAAV;AAAA,OAAtB,CAAP;AACD;;;gCAEW;AAAA;;AACV,UAAI,CAAC,KAAK,aAAV,EAAyB;AACvB,aAAK,aAAL,GAAqB,UAAU,cAAM;AACnC,iBAAK,IAAL,CAAU,MAAV,CAAiB;AACf,oBAAQ,OAAK,UADE;AAEf,mBAAO;AAFQ,WAAjB,EAGG,EAHH;AAID,SALoB,CAArB;AAMD;AACD,aAAO,KAAK,aAAZ;AACD;;;;;kBAzDkB,W","file":"update-issue.js","sourcesContent":["import _ from \"lodash\";\nimport octonode from \"octonode\";\n\nfunction promisify(fn) {\n  return new Promise((resolve, reject) => {\n    fn((err, result) => err ? reject(err) : resolve(result));\n  });\n}\n\nexport default class UpdateIssue {\n  constructor({ githubRepo, githubToken, issueLabel, issueTitle, issueBody }) {\n    this.githubRepo = githubRepo;\n    this.client = octonode.client(githubToken);\n    this.repo = this.client.repo(this.githubRepo);\n    this.issueLabel = issueLabel;\n    this.issueTitleTemplate = _.template(issueTitle);\n    this.issueBodyTemplate = _.template(issueBody);\n  }\n\n  createOrUpdate(update) {\n    return this.findExistIssue(update).then(issue => {\n      if (issue) {\n        return this.update(issue, update);\n      } else {\n        return this.create(update);\n      }\n    });\n  }\n\n  create(update) {\n    return promisify(cb => {\n      this.repo.issue({\n        title: this.issueTitleTemplate(update),\n        body: this.issueBodyTemplate(update),\n        labels: [this.issueLabel],\n      }, cb);\n    });\n  }\n\n  update(issue, update) {\n    const title = this.issueTitleTemplate(update);\n    const body = this.issueBodyTemplate(update);\n    if (title === issue.title && body === issue.body) {\n      return Promise.resolve(issue);\n    }\n\n    return promisify(cb => {\n      this.client.issue(this.githubRepo, issue.id).update({ title, body }, cb);\n    });\n  }\n\n  findExistIssue(update) {\n    const title = this.issueTitleTemplate(update);\n    return this.getIssues().then(issues => _.find(issues, [\"title\", title]));\n  }\n\n  getIssues() {\n    if (!this.issuesPromise) {\n      this.issuesPromise = promisify(cb => {\n        this.repo.issues({\n          labels: this.issueLabel,\n          state: \"open\"\n        }, cb);\n      });\n    }\n    return this.issuesPromise;\n  }\n}\n"]}